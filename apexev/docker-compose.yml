# ==========================================
# Docker Compose for ApexEV Local Development
# ==========================================
# This file allows you to run the entire stack (app + database) locally
# Usage:
#   docker-compose up -d        # Start all services
#   docker-compose down         # Stop all services
#   docker-compose logs -f app  # View app logs

services:
  # ==========================================
  # MySQL Database Service
  # ==========================================
  mysql:
    image: mysql:8.0
    container_name: apexev-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: apexev
      MYSQL_USER: apexev
      MYSQL_PASSWORD: apexevpassword
    ports:
      - "3307:3306"  # Map to 3307 to avoid conflict with local MySQL
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - apexev-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================
  # Spring Boot Application Service
  # ==========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: apexev-app
    restart: unless-stopped
    environment:
      # ==========================================
      # Database Configuration
      # ==========================================
      DB_URL: jdbc:mysql://mysql:3306/apexev?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      DB_USERNAME: apexev
      DB_PASSWORD: apexevpassword
      
      # ==========================================
      # JWT Configuration
      # ==========================================
      JWT_SECRET: HanhTrinhLenMayCungFCJ123456789012
      JWT_EXPIRATION_MS: 86400000
      JWT_REFRESH_EXPIRATION_MS: 604800000
      
      # ==========================================
      # Mail Configuration
      # ==========================================
      MAIL_HOST: smtp.gmail.com
      MAIL_PORT: 587
      MAIL_USERNAME: apexevcompany@gmail.com
      MAIL_PASSWORD: ndxxxdhertvngqja
      MAIL_FROM: dinhphat@gmail.com
      
      # ==========================================
      # Server Configuration
      # ==========================================
      SERVER_PORT: 8080
      API_SERVER_URL: http://localhost:8080
      API_SERVER_NAME: Docker Development Server
      
      # ==========================================
      # JPA/Hibernate Configuration
      # ==========================================
      DDL_AUTO: update
      SHOW_SQL: "false"
      
      # ==========================================
      # Logging Configuration
      # ==========================================
      LOG_LEVEL_SECURITY: INFO
      
      # ==========================================
      # Actuator Configuration
      # ==========================================
      ACTUATOR_ENDPOINTS: health,info,metrics
      HEALTH_SHOW_DETAILS: always
      
    ports:
      - "8081:8080"  # Map container port 8080 to host port 8081 (avoid conflict)
    depends_on:
      mysql:
        condition: service_healthy  # Wait for MySQL to be healthy before starting app
    networks:
      - apexev-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 60s

# ==========================================
# Volumes
# ==========================================
volumes:
  mysql-data:
    driver: local

# ==========================================
# Networks
# ==========================================
networks:
  apexev-network:
    driver: bridge
